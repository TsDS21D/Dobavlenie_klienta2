# calculator/models_list_proschet.py
"""
–ú–æ–¥–µ–ª—å Prosche—Ç (–ü—Ä–æ—Å—á—ë—Ç) –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏.
–í–∫–ª—é—á–∞–µ—Ç –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–µ—á–∞—Ç–∏ (—Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º KP-) –∏ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã (—Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º DR-).
"""

from django.db import models  # –ò–º–ø–æ—Ä—Ç –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –º–æ–¥–µ–ª–µ–π Django
from django.db.models import Max, Sum, F  # –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å QuerySet
from django.core.validators import MinValueValidator  # –ò–º–ø–æ—Ä—Ç –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
from decimal import Decimal  # –ò–º–ø–æ—Ä—Ç Decimal –¥–ª—è —Ç–æ—á–Ω—ã—Ö –¥–µ–Ω–µ–∂–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
from django.utils import timezone  # –ò–º–ø–æ—Ä—Ç —É—Ç–∏–ª–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏ –∏ –≤—Ä–µ–º–µ–Ω–µ–º
import math  # –ò–º–ø–æ—Ä—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤


class Proschet(models.Model):
    """
    –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Å—á—ë—Ç–∞—Ö.
    –ì–ª–∞–≤–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ —Ä–∞—Å—á–µ—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞.
    """
    
    # –ü–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –ø—Ä–æ—Å—á–µ—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PR-1, PR-2 –∏ —Ç.–¥.
    number = models.CharField(
        verbose_name='–ù–æ–º–µ—Ä –ø—Ä–æ—Å—á—ë—Ç–∞',  # –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –∏–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ
        max_length=20,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏ (20 —Å–∏–º–≤–æ–ª–æ–≤)
        unique=True,  # –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        blank=True,  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ö
        help_text='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ PR-1, PR-2 –∏ —Ç.–¥.'  # –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    )
    
    # –ü–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ—Å—á–µ—Ç–∞
    title = models.CharField(
        verbose_name='–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Å—á—ë—Ç–∞',
        max_length=200,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ 200 —Å–∏–º–≤–æ–ª–æ–≤
        help_text='–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞'  # –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø–æ–ª—è
    )
    
    # –ü–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏—Ä–∞–∂–∞ - –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –ø—Ä–æ–¥—É–∫—Ü–∏–∏
    circulation = models.PositiveIntegerField(
        verbose_name='–¢–∏—Ä–∞–∂',
        null=True,  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ NULL –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        blank=True,  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ö
        default=1,  # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - 1 —ç–∫–∑–µ–º–ø–ª—è—Ä
        help_text='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ (—Ç–∏—Ä–∞–∂). –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1'
    )
    
    # –í–Ω–µ—à–Ω–∏–π –∫–ª—é—á –∫ –º–æ–¥–µ–ª–∏ Client –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è baza_klientov
    client = models.ForeignKey(
        'baza_klientov.Client',  # –°—Å—ã–ª–∫–∞ –Ω–∞ –º–æ–¥–µ–ª—å –≤ –¥—Ä—É–≥–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
        verbose_name='–ö–ª–∏–µ–Ω—Ç',
        on_delete=models.SET_NULL,  # –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è NULL
        null=True,  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ NULL –∑–Ω–∞—á–µ–Ω–∏–µ
        blank=True,  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ö
        help_text='–ö–ª–∏–µ–Ω—Ç, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ—Å—á—ë—Ç'
    )
    
    # –ü–æ–ª–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
    created_at = models.DateTimeField(
        verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è',
        auto_now_add=True,  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏
        help_text='–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Å—á—ë—Ç–∞'
    )
    
    # –§–ª–∞–≥ –¥–ª—è –º—è–≥–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π (–≤–º–µ—Å—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –ë–î)
    is_deleted = models.BooleanField(
        verbose_name='–£–¥–∞–ª–µ–Ω',
        default=False,  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø–∏—Å—å –Ω–µ —É–¥–∞–ª–µ–Ω–∞
        help_text='–ü–æ–º–µ—á–∞–µ—Ç –ø—Ä–æ—Å—á—ë—Ç –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–π'
    )
    
    class Meta:
        """–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è"""
        verbose_name = '–ü—Ä–æ—Å—á—ë—Ç'  # –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        verbose_name_plural = '–ü—Ä–æ—Å—á—ë—Ç—ã'  # –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        ordering = ['-created_at']  # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
    
    def __str__(self):
        """
        –ú–µ—Ç–æ–¥ –¥–ª—è —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∞–¥–º–∏–Ω–∫–µ –∏ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ –æ–±—ä–µ–∫—Ç–æ–≤.
        """
        # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–∏—Ä–∞–∂–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç–µ—Ä–Ω–∞—Ä–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        circulation_text = f"–¢–∏—Ä–∞–∂: {self.circulation}" if self.circulation is not None else "–¢–∏—Ä–∞–∂ –Ω–µ —É–∫–∞–∑–∞–Ω"
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ, –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω
        if self.client:
            return f"{self.number}: {self.title} ({circulation_text}, –ö–ª–∏–µ–Ω—Ç: {self.client.name})"
        return f"{self.number}: {self.title} ({circulation_text})"
    
    def save(self, *args, **kwargs):
        """
        –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞.
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î.
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å—å—é –∏–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π
        is_new = self.pk is None
        
        # –ï—Å–ª–∏ —ç—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∑–∞–ø–∏—Å—å, –ø–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        old_circulation = None
        if not is_new:
            try:
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
                old_instance = Proschet.objects.get(pk=self.pk)
                old_circulation = old_instance.circulation
            except Proschet.DoesNotExist:
                pass  # –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ), –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ —Å–æ—Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–æ–±–µ–ª–æ–≤
        if not self.number or self.number.strip() == '':
            try:
                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–æ–º–µ—Ä–∞, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å PR-
                existing_numbers = Proschet.objects.filter(
                    number__startswith='PR-'  # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É
                ).exclude(number__exact='').exclude(number__isnull=True).values_list('number', flat=True)
                
                max_num = 0  # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
                
                # –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ –≤—Å–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–∞–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                for num_str in existing_numbers:
                    try:
                        # –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ –¥–µ—Ñ–∏—Å—É –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–∏—Å–ª–æ–≤–æ–π —á–∞—Å—Ç–∏
                        num_part = num_str.split('-')[1]
                        current_num = int(num_part)  # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
                        if current_num > max_num:
                            max_num = current_num  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                    except (ValueError, IndexError, AttributeError):
                        continue  # –ü—Ä–æ–ø—É—Å–∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –Ω–æ–º–µ—Ä–∞
                
                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞ (–Ω–∞ 1 –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ)
                new_num = max_num + 1
                self.number = f"PR-{new_num}"
                
            except Exception as e:
                # Fallback-–º–µ—Ç–æ–¥ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏: –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
                count = Proschet.objects.count()  # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π
                self.number = f"PR-{count + 1}"
                print(f"‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω fallback –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞: {self.number}")
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –Ω–æ–º–µ—Ä –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—É—Å—Ç–æ–π, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π
        if not self.number or self.number.strip() == '':
            count = Proschet.objects.count()
            self.number = f"PR-{count + 1}"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç (–≤—ã–∑—ã–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –º–µ—Ç–æ–¥ save)
        super().save(*args, **kwargs)
        
        # –í–ê–ñ–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ï—Å–ª–∏ —Ç–∏—Ä–∞–∂ –∏–∑–º–µ–Ω–∏–ª—Å—è, –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–µ—á–∞—Ç–∏
        if not is_new and old_circulation != self.circulation:
            print(f"üîÑ –¢–∏—Ä–∞–∂ –∏–∑–º–µ–Ω–∏–ª—Å—è —Å {old_circulation} –Ω–∞ {self.circulation}. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø–µ—á–∞—Ç–∏...")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–µ—á–∞—Ç–∏
            updated_count = 0
            for component in self.print_components.all():
                # –û–±–Ω–æ–≤–ª—è–µ–º sheet_count –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
                component.sheet_count = self.circulation if self.circulation is not None else 1
                component.save()  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (–ø—Ä–∏ —ç—Ç–æ–º —Ç–∞–∫–∂–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è —Ü–µ–Ω–∞)
                updated_count += 1
            
            print(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ {updated_count} –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø–µ—á–∞—Ç–∏")
    
    @property
    def formatted_created_at(self):
        """–°–≤–æ–π—Å—Ç–≤–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è"""
        if self.created_at:
            # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
            from django.utils import timezone
            local_time = timezone.localtime(self.created_at)
            return local_time.strftime("%d.%m.%Y %H:%M")  # –§–æ—Ä–º–∞—Ç: –¥–µ–Ω—å.–º–µ—Å—è—Ü.–≥–æ–¥ —á–∞—Å:–º–∏–Ω—É—Ç–∞
        return ""  # –í–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –µ—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
    
    @property
    def total_price(self):
        """
        –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–æ—Å—á–µ—Ç–∞.
        –í–∫–ª—é—á–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø–µ—á–∞—Ç–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç.
        """
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è —Å—É–º–º—ã —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        components_total = Decimal('0.00')
        
        # –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ –≤—Å–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º –ø–µ—á–∞—Ç–∏
        for component in self.print_components.all():
            components_total += component.total_circulation_price  # –°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
        
        # –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–ª—è —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤—Å–µ—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç
        works_total = self.additional_works.aggregate(
            total=Sum('price')  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ Sum –¥–ª—è —Å–ª–æ–∂–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª—è price
        )['total'] or Decimal('0.00')  # –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç None, –∏—Å–ø–æ–ª—å–∑—É–µ–º 0.00
        
        # –í–æ–∑–≤—Ä–∞—Ç –æ–±—â–µ–π —Å—É–º–º—ã (–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã + —Ä–∞–±–æ—Ç—ã)
        return components_total + works_total
    
    @property
    def formatted_total_price(self):
        """–°–≤–æ–π—Å—Ç–≤–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏"""
        return f"{self.total_price:.2f} ‚ÇΩ"  # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –¥–≤—É–º—è –∑–Ω–∞–∫–∞–º–∏ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π –∏ —Å–∏–º–≤–æ–ª–æ–º —Ä—É–±–ª—è
    
    @property
    def formatted_circulation(self):
        """–°–≤–æ–π—Å—Ç–≤–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–∏—Ä–∞–∂–∞ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á"""
        if self.circulation is not None:
            # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á –∏ –∑–∞–º–µ–Ω–æ–π –∑–∞–ø—è—Ç–æ–π –Ω–∞ –ø—Ä–æ–±–µ–ª
            return f"{self.circulation:,}".replace(",", " ")
        return "–ù–µ —É–∫–∞–∑–∞–Ω"  # –í–æ–∑–≤—Ä–∞—Ç —Ç–µ–∫—Å—Ç–∞ –≤–º–µ—Å—Ç–æ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏

    def update_circulation(self, new_circulation):
        """
        –ú–µ—Ç–æ–¥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∏—Ä–∞–∂–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π.
        
        Args:
            new_circulation (int): –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∏—Ä–∞–∂–∞
            
        Returns:
            tuple: (bool —É—Å–ø–µ—Ö, str —Å–æ–æ–±—â–µ–Ω–∏–µ)
        """
        try:
            # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
            circulation_int = int(new_circulation)
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è: —Ç–∏—Ä–∞–∂ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º
            if circulation_int <= 0:
                return False, "–¢–∏—Ä–∞–∂ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º"
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            old_circulation = self.circulation
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
            self.circulation = circulation_int
            self.save()  # –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ save –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ç–∏—Ä–∞–∂
            if old_circulation != circulation_int:
                return True, f"–¢–∏—Ä–∞–∂ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω —Å {old_circulation} –Ω–∞ {circulation_int}. –°–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–µ—á–∞—Ç–∏ —Ç–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã."
            else:
                return True, "–¢–∏—Ä–∞–∂ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω (–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)"
            
        except ValueError:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
            return False, "–¢–∏—Ä–∞–∂ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º"
        except Exception as e:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
            return False, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–∏—Ä–∞–∂–∞: {str(e)}"


class PrintComponent(models.Model):
    """
    –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–µ—á–∞—Ç–∏ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º KP-.
    –°–≤—è–∑–∞–Ω —Å –ø—Ä–æ—Å—á–µ—Ç–æ–º (Proschet) –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—á–∞—Ç–∏.
    –í–ê–ñ–ù–û: –¢–µ–ø–µ—Ä—å –ø–æ–ª–µ sheet_count –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–∏—Ä–∞–∂–∞ –ø—Ä–æ—Å—á–µ—Ç–∞
    """
    
    # –ü–æ–ª–µ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ KP-1, KP-2 –∏ —Ç.–¥.
    number = models.CharField(
        verbose_name='–ù–æ–º–µ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞',
        max_length=20,
        unique=True,
        blank=True,
        help_text='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ KP-1, KP-2 –∏ —Ç.–¥.'
    )
    
    # –í–Ω–µ—à–Ω–∏–π –∫–ª—é—á –∫ –º–æ–¥–µ–ª–∏ Proschet —Å –∫–∞—Å–∫–∞–¥–Ω—ã–º —É–¥–∞–ª–µ–Ω–∏–µ–º
    proschet = models.ForeignKey(
        Proschet,
        verbose_name='–ü—Ä–æ—Å—á—ë—Ç',
        on_delete=models.CASCADE,  # –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ—Å—á–µ—Ç–∞ —É–¥–∞–ª—è—é—Ç—Å—è –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        related_name='print_components',  # –ò–º—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –∏–∑ Proschet
        help_text='–ü—Ä–æ—Å—á—ë—Ç, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —ç—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç'
    )
    
    # –í–Ω–µ—à–Ω–∏–π –∫–ª—é—á –∫ –º–æ–¥–µ–ª–∏ Printer –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è devices
    printer = models.ForeignKey(
        'devices.Printer',
        verbose_name='–ü—Ä–∏–Ω—Ç–µ—Ä',
        on_delete=models.PROTECT,  # –ó–∞–ø—Ä–µ—Ç —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞, –µ—Å–ª–∏ —Å –Ω–∏–º —Å–≤—è–∑–∞–Ω—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        related_name='print_components',
        help_text='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–Ω—Ç–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤',
        null=True,
        blank=True
    )
    
    # –í–Ω–µ—à–Ω–∏–π –∫–ª—é—á –∫ –º–æ–¥–µ–ª–∏ Material –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è sklad
    paper = models.ForeignKey(
        'sklad.Material',
        verbose_name='–ë—É–º–∞–≥–∞',
        on_delete=models.SET_NULL,  # –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è NULL
        null=True,
        blank=True,  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ö
        help_text='–í—ã–±–µ—Ä–∏—Ç–µ –±—É–º–∞–≥—É –∏–∑ —Å–ø–∏—Å–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ. –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ.'
    )
    
    # –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–æ–ª–µ "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Å—Ç–æ–≤" —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–∏—Ä–∞–∂–∞ –ø—Ä–æ—Å—á–µ—Ç–∞
    sheet_count = models.PositiveIntegerField(
        verbose_name='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Å—Ç–æ–≤',
        null=True,  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ NULL –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        blank=True,  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ö
        validators=[MinValueValidator(1)],  # –í–∞–ª–∏–¥–∞—Ç–æ—Ä: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ 1
        help_text='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—á–∞—Ç–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ä–∞–≤–Ω—ã–º —Ç–∏—Ä–∞–∂—É –∏–∑ –ø—Ä–æ—Å—á–µ—Ç–∞.'
    )
    
    # –ü–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –ø–µ—á–∞—Ç–∏ –æ–¥–Ω–æ–≥–æ –ª–∏—Å—Ç–∞
    price_per_sheet = models.DecimalField(
        verbose_name='–¶–µ–Ω–∞ –ø–µ—á–∞—Ç–∏ –∑–∞ –ª–∏—Å—Ç',
        max_digits=10,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ñ—Ä (–≤–∫–ª—é—á–∞—è –¥—Ä–æ–±–Ω—É—é —á–∞—Å—Ç—å)
        decimal_places=2,  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
        null=True,  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ NULL –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        blank=True,  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ö
        validators=[MinValueValidator(Decimal('0.00'))],  # –í–∞–ª–∏–¥–∞—Ç–æ—Ä: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ 0.00
        help_text='–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ –æ–¥–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ –≤ —Ä—É–±–ª—è—Ö (–±–µ–∑ —É—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞). –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –∏ —Ç–∏—Ä–∞–∂–∞.'
    )
    
    # –ü–æ–ª–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
    created_at = models.DateTimeField(
        verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è',
        auto_now_add=True,
        help_text='–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞'
    )
    
    # –§–ª–∞–≥ –¥–ª—è –º—è–≥–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π
    is_deleted = models.BooleanField(
        verbose_name='–£–¥–∞–ª–µ–Ω',
        default=False,
        help_text='–ü–æ–º–µ—á–∞–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–π'
    )
    
    # –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π –Ω–∞ —Å–ø–æ—Å–æ–± —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π/—Ä—É—á–Ω–æ–π)
    is_price_calculated = models.BooleanField(
        verbose_name='–¶–µ–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏',
        default=False,
        help_text='–£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —Ü–µ–Ω–∞ –∑–∞ –ª–∏—Å—Ç –±—ã–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Ü–µ–Ω'
    )
    
    class Meta:
        """–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ"""
        verbose_name = '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–µ—á–∞—Ç–∏'
        verbose_name_plural = '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–µ—á–∞—Ç–∏'
        ordering = ['created_at']  # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º)
    
    def __str__(self):
        """–°—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –ø–µ—á–∞—Ç–∏"""
        paper_name = self.paper.name if self.paper else '–ë—É–º–∞–≥–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞'
        printer_name = self.printer.name if self.printer else '–ë–µ–∑ –ø—Ä–∏–Ω—Ç–µ—Ä–∞'
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–∏—Ä–∞–∂–µ –∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å—á–µ—Ç–∞
        circulation_text = f"–¢–∏—Ä–∞–∂: {self.proschet.circulation}" if self.proschet and self.proschet.circulation is not None else "–¢–∏—Ä–∞–∂ –Ω–µ —É–∫–∞–∑–∞–Ω"
        return f"{self.number}: {printer_name} - {paper_name} ({circulation_text})"
    
    def save(self, *args, **kwargs):
        """
        –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π:
        1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
        2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ sheet_count –∏–∑ —Ç–∏—Ä–∞–∂–∞ –ø—Ä–æ—Å—á–µ—Ç–∞
        3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –∑–∞ –ª–∏—Å—Ç
        """
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –ø—Ä–æ–±–µ–ª–æ–≤
        if not self.number or self.number.strip() == '':
            try:
                # –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –Ω–æ–º–µ—Ä–æ–≤ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º KP-
                existing_numbers = PrintComponent.objects.filter(
                    number__startswith='KP-'
                ).exclude(number__exact='').exclude(number__isnull=True).values_list('number', flat=True)
                
                max_num = 0  # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
                
                # –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                for num_str in existing_numbers:
                    try:
                        num_part = num_str.split('-')[1]  # –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ –¥–µ—Ñ–∏—Å—É
                        current_num = int(num_part)  # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
                        if current_num > max_num:
                            max_num = current_num  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                    except (ValueError, IndexError, AttributeError):
                        continue  # –ü—Ä–æ–ø—É—Å–∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
                
                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞
                new_num = max_num + 1
                self.number = f"KP-{new_num}"
                
            except Exception as e:
                # Fallback-–º–µ—Ç–æ–¥ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                count = PrintComponent.objects.count()
                self.number = f"KP-{count + 1}"
                print(f"‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω fallback –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ (PrintComponent): {self.number}")
        
        # –í–ê–ñ–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ sheet_count –∏–∑ —Ç–∏—Ä–∞–∂–∞ –ø—Ä–æ—Å—á–µ—Ç–∞
        if self.proschet and self.proschet.circulation is not None:
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è sheet_count —Ä–∞–≤–Ω—ã–º —Ç–∏—Ä–∞–∂—É –∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å—á–µ—Ç–∞
            self.sheet_count = self.proschet.circulation
            print(f"‚úÖ sheet_count —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∏—Ä–∞–∂–∞: {self.proschet.circulation}")
        else:
            # –ï—Å–ª–∏ —Ç–∏—Ä–∞–∂ –Ω–µ —É–∫–∞–∑–∞–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if self.sheet_count is None:
                self.sheet_count = 1
                print(f"‚ö†Ô∏è sheet_count —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –∑–∞ –ª–∏—Å—Ç
        should_calculate_price = False
        
        # –£—Å–ª–æ–≤–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã: –Ω–∞–ª–∏—á–∏–µ –ø—Ä–∏–Ω—Ç–µ—Ä–∞, –ø—Ä–æ—Å—á–µ—Ç–∞ –∏ —Ç–∏—Ä–∞–∂–∞
        if self.printer and self.proschet and self.proschet.circulation:
            # –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –¥–ª—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –∏–ª–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–∞/—Ç–∏—Ä–∞–∂–∞
            if not self.pk:  # –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç primary key)
                should_calculate_price = True
            else:
                # –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                try:
                    old_component = PrintComponent.objects.get(pk=self.pk)
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø—Ä–∏–Ω—Ç–µ—Ä–µ –∏–ª–∏ —Ç–∏—Ä–∞–∂–µ
                    if (old_component.printer != self.printer or 
                        old_component.proschet.circulation != self.proschet.circulation):
                        should_calculate_price = True
                except PrintComponent.DoesNotExist:
                    should_calculate_price = True
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if self.printer and self.proschet and self.proschet.circulation:
            try:
                # –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –∏ —Ç–∏—Ä–∞–∂–∞
                calculated_price = self.calculate_price_for_printer_and_copies(
                    self.printer, 
                    self.proschet.circulation
                )
                self.price_per_sheet = calculated_price
                self.is_price_calculated = True  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
                print(f"‚úÖ –¶–µ–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: {self.price_per_sheet} —Ä—É–±./–ª–∏—Å—Ç –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ '{self.printer.name}' –∏ —Ç–∏—Ä–∞–∂–∞ {self.proschet.circulation} —à—Ç.")
            except Exception as e:
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Ä–∞—Å—á–µ—Ç–µ —Ü–µ–Ω—ã: {str(e)}")
                if self.price_per_sheet is None:
                    self.price_per_sheet = Decimal('0.00')
                self.is_price_calculated = False
        else:
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
            if self.price_per_sheet is None:
                self.price_per_sheet = Decimal('0.00')
            self.is_price_calculated = False
        
        # –í—ã–∑–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –º–µ—Ç–æ–¥–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
        super().save(*args, **kwargs)
    
    @staticmethod
    def calculate_price_for_printer_and_copies(printer, copies):
        """
        –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –∑–∞ –ª–∏—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –∏ —Ç–∏—Ä–∞–∂–∞.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Ü–µ–Ω –∏ –º–µ—Ç–æ–¥—ã –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏.
        
        Args:
            printer: –û–±—ä–µ–∫—Ç –º–æ–¥–µ–ª–∏ Printer
            copies: int, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ø–∏–π (—Ç–∏—Ä–∞–∂)
        
        Returns:
            Decimal: —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ –ª–∏—Å—Ç
        """
        try:
            # –ò–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–∏ –∑–¥–µ—Å—å –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
            from print_price.models import PrintPrice
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ü–µ–Ω–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ —Ç–∏—Ä–∞–∂—É
            price_points = PrintPrice.objects.filter(printer=printer).order_by('copies')
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ü–µ–Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if not price_points.exists():
                return Decimal('0.00')  # –í–æ–∑–≤—Ä–∞—Ç –Ω—É–ª–µ–≤–æ–π —Ü–µ–Ω—ã –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
            
            # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–∏—Ä–∞–∂–∞ –≤ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
            copies_int = int(copies)
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ –∏–∑ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ª–∏–Ω–µ–π–Ω—ã–π)
            interpolation_method = getattr(printer, 'devices_interpolation_method', 'linear')
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω–æ–≤—ã—Ö —Ç–æ—á–µ–∫
            min_price = price_points.first()
            max_price = price_points.last()
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞–µ–≤ –∫–æ–≥–¥–∞ —Ç–∏—Ä–∞–∂ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∏–ª–∏ –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ
            if copies_int <= min_price.copies:
                return min_price.price_per_sheet
            if copies_int >= max_price.copies:
                return max_price.price_per_sheet
            
            # –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–∏—Ö —Ü–µ–Ω–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
            prev_price = None  # –¶–µ–Ω–æ–≤–∞—è —Ç–æ—á–∫–∞ —Å —Ç–∏—Ä–∞–∂–æ–º <= –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–º—É
            next_price = None  # –¶–µ–Ω–æ–≤–∞—è —Ç–æ—á–∫–∞ —Å —Ç–∏—Ä–∞–∂–æ–º >= –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–º—É
            
            for price in price_points:
                if price.copies <= copies_int:
                    prev_price = price
                if price.copies >= copies_int:
                    next_price = price
                    break  # –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ —Ü–∏–∫–ª–∞ –ø–æ—Å–ª–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π —Ç–æ—á–∫–∏
            
            # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥–≤—É—Ö —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–æ—á–µ–∫
            if prev_price and next_price and prev_price != next_price:
                
                # –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
                if interpolation_method == 'linear':
                    x1, y1 = float(prev_price.copies), float(prev_price.price_per_sheet)
                    x2, y2 = float(next_price.copies), float(next_price.price_per_sheet)
                    x = float(copies_int)
                    
                    # –§–æ—Ä–º—É–ª–∞ –ª–∏–Ω–µ–π–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏: y = y1 + (y2 - y1) * (x - x1) / (x2 - x1)
                    result = y1 + (y2 - y1) * (x - x1) / (x2 - x1)
                    calculated_price = Decimal(str(round(result, 2)))  # –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 2 –∑–Ω–∞–∫–æ–≤
                
                # –õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
                elif interpolation_method == 'logarithmic':
                    epsilon = 1e-10  # –ú–∞–ª–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ª–æ–≥–∞—Ä–∏—Ñ–º–∞ –æ—Ç 0
                    
                    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –≤ –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫—É—é —à–∫–∞–ª—É
                    x1 = math.log(float(prev_price.copies) + epsilon)
                    y1 = math.log(float(prev_price.price_per_sheet) + epsilon)
                    x2 = math.log(float(next_price.copies) + epsilon)
                    y2 = math.log(float(next_price.price_per_sheet) + epsilon)
                    x = math.log(float(copies_int) + epsilon)
                    
                    # –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –≤ –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–π —à–∫–∞–ª–µ
                    result_log = y1 + (y2 - y1) * (x - x1) / (x2 - x1)
                    result = math.exp(result_log) - epsilon  # –û–±—Ä–∞—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–∑ –ª–æ–≥–∞—Ä–∏—Ñ–º–∞
                    calculated_price = Decimal(str(round(result, 2)))
                
                else:
                    # –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
                    x1, y1 = float(prev_price.copies), float(prev_price.price_per_sheet)
                    x2, y2 = float(next_price.copies), float(next_price.price_per_sheet)
                    x = float(copies_int)
                    
                    result = y1 + (y2 - y1) * (x - x1) / (x2 - x1)
                    calculated_price = Decimal(str(round(result, 2)))
            
            else:
                # –í–æ–∑–≤—Ä–∞—Ç –±–ª–∏–∂–∞–π—à–µ–π —Ü–µ–Ω—ã –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–≤—É—Ö —Ç–æ—á–µ–∫ –¥–ª—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
                calculated_price = prev_price.price_per_sheet if prev_price else min_price.price_per_sheet
            
            return calculated_price
            
        except Exception as e:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π —Å –≤—ã–≤–æ–¥–æ–º –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ calculate_price_for_printer_and_copies: {str(e)}")
            return Decimal('0.00')
    
    def clean(self):
        """–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –º–æ–¥–µ–ª–∏"""
        pass  # –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
    
    # –°–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
    @property
    def printer_sheet_format(self):
        """–§–æ—Ä–º–∞—Ç –ª–∏—Å—Ç–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–∞"""
        return self.printer.sheet_format if self.printer else None
    
    @property
    def printer_margin_mm(self):
        """–ü–æ–ª—è –ø–µ—á–∞—Ç–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö"""
        return self.printer.margin_mm if self.printer else None
    
    @property
    def printer_duplex_coefficient(self):
        """–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π –ø–µ—á–∞—Ç–∏"""
        return self.printer.duplex_coefficient if self.printer else None
    
    @property
    def printer_sheet_format_display(self):
        """–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –ª–∏—Å—Ç–∞"""
        if self.printer and self.printer.sheet_format:
            return self.printer.sheet_format.name
        return "–ù–µ —É–∫–∞–∑–∞–Ω"
    
    @property
    def printer_margin_display(self):
        """–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–µ–π –ø–µ—á–∞—Ç–∏"""
        if self.printer:
            return f"{self.printer.margin_mm} –º–º"
        return "–ù–µ —É–∫–∞–∑–∞–Ω"
    
    @property
    def printer_duplex_display(self):
        """–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π –ø–µ—á–∞—Ç–∏"""
        if self.printer:
            if self.printer.duplex_coefficient.is_integer():
                return f"{int(self.printer.duplex_coefficient)}"
            else:
                return f"{self.printer.duplex_coefficient:.1f}"
        return "–ù–µ —É–∫–∞–∑–∞–Ω"
    
    @property
    def material_price_per_unit(self):
        """–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞"""
        if self.paper:
            return self.paper.price
        return Decimal('0.00')
    
    @property
    def total_circulation_price(self):
        """
        –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ–±—â–µ–π —Ü–µ–Ω—ã –∑–∞ —Ç–∏—Ä–∞–∂.
        
        –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–û–†–ú–£–õ–ê: (–¶–µ–Ω–∞ –ø–µ—á–∞—Ç–∏ –∑–∞ –ª–∏—Å—Ç + –¶–µ–Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∑–∞ –ª–∏—Å—Ç) √ó –¢–∏—Ä–∞–∂ –∏–∑ –ø—Ä–æ—Å—á—ë—Ç–∞
        
        Returns:
            Decimal: –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–∏—Ä–∞–∂–∞
        """
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∏—Ä–∞–∂–∞ –∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å—á–µ—Ç–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        circulation = self.proschet.circulation if (self.proschet and self.proschet.circulation is not None) else 1
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è –∫–æ–≥–¥–∞ price_per_sheet —Ä–∞–≤–Ω–æ None
        price_per_sheet = self.price_per_sheet if self.price_per_sheet is not None else Decimal('0.00')
        
        # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–¥–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ (–ø–µ—á–∞—Ç—å + –º–∞—Ç–µ—Ä–∏–∞–ª)
        cost_per_sheet = price_per_sheet + self.material_price_per_unit
        
        # –£–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–∞ —Ç–∏—Ä–∞–∂ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        return cost_per_sheet * circulation
    
    @property
    def formatted_price_per_sheet(self):
        """–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ –ø–µ—á–∞—Ç–∏ –∑–∞ –ª–∏—Å—Ç"""
        if self.price_per_sheet is not None:
            return f"{self.price_per_sheet:.2f} ‚ÇΩ"
        return "0.00 ‚ÇΩ"
    
    @property
    def formatted_total_circulation_price(self):
        """–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ —Ç–∏—Ä–∞–∂"""
        return f"{self.total_circulation_price:.2f} ‚ÇΩ"
    
    @property
    def formatted_material_price(self):
        """–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –∏–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–∞"""
        return f"{self.material_price_per_unit:.2f} ‚ÇΩ" if self.paper else "–ù–µ –≤—ã–±—Ä–∞–Ω–æ"
    
    @property
    def material_cost_for_circulation(self):
        """
        –°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è –≤—Å–µ–≥–æ —Ç–∏—Ä–∞–∂–∞.
        
        –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–û–†–ú–£–õ–ê: –¶–µ–Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∑–∞ –ª–∏—Å—Ç √ó –¢–∏—Ä–∞–∂ –∏–∑ –ø—Ä–æ—Å—á—ë—Ç–∞
        
        Returns:
            Decimal: –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è —Ç–∏—Ä–∞–∂–∞
        """
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∏—Ä–∞–∂–∞ –∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å—á–µ—Ç–∞
        circulation = self.proschet.circulation if (self.proschet and self.proschet.circulation is not None) else 1
        
        # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è —Ç–∏—Ä–∞–∂–∞
        return self.material_price_per_unit * circulation
    
    @property
    def formatted_material_cost_for_circulation(self):
        """–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è —Ç–∏—Ä–∞–∂–∞"""
        return f"{self.material_cost_for_circulation:.2f} ‚ÇΩ"
    
    @property
    def printing_cost_for_circulation(self):
        """
        –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ –¥–ª—è –≤—Å–µ–≥–æ —Ç–∏—Ä–∞–∂–∞ (–±–µ–∑ —É—á–µ—Ç–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞).
        
        –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–û–†–ú–£–õ–ê: –¶–µ–Ω–∞ –ø–µ—á–∞—Ç–∏ –∑–∞ –ª–∏—Å—Ç √ó –¢–∏—Ä–∞–∂ –∏–∑ –ø—Ä–æ—Å—á—ë—Ç–∞
        
        Returns:
            Decimal: –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ –¥–ª—è —Ç–∏—Ä–∞–∂–∞
        """
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∏—Ä–∞–∂–∞ –∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å—á–µ—Ç–∞
        circulation = self.proschet.circulation if (self.proschet and self.proschet.circulation is not None) else 1
        
        # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–µ—á–∞—Ç–∏ –¥–ª—è —Ç–∏—Ä–∞–∂–∞
        if self.price_per_sheet is not None:
            return self.price_per_sheet * circulation
        return Decimal('0.00')
    
    @property
    def formatted_printing_cost_for_circulation(self):
        """–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ –¥–ª—è —Ç–∏—Ä–∞–∂–∞"""
        return f"{self.printing_cost_for_circulation:.2f} ‚ÇΩ"
    
    @property
    def circulation_display(self):
        """
        –°–≤–æ–π—Å—Ç–≤–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∏—Ä–∞–∂–∞ –∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å—á—ë—Ç–∞.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∞–¥–º–∏–Ω–∫–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∏—Ä–∞–∂–∞.
        """
        if self.proschet and self.proschet.circulation is not None:
            return self.proschet.circulation
        return "–ù–µ —É–∫–∞–∑–∞–Ω"
    
    @property
    def formatted_circulation_display(self):
        """
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∏—Ä–∞–∂–∞ –∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å—á—ë—Ç–∞.
        –° —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á.
        """
        if self.proschet and self.proschet.circulation is not None:
            return f"{self.proschet.circulation:,}".replace(",", " ")
        return "–ù–µ —É–∫–∞–∑–∞–Ω"
    
    @property
    def display_info(self):
        """–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
        circulation_text = f"–¢–∏—Ä–∞–∂: {self.formatted_circulation_display}"
        info = f"{circulation_text}"
        info += f" | {self.printer.name if self.printer else '–ë–µ–∑ –ø—Ä–∏–Ω—Ç–µ—Ä–∞'}"
        if self.paper:
            info += f" | {self.paper.name}"
        info += f" | –ü–µ—á–∞—Ç—å: {self.formatted_price_per_sheet} –∑–∞ –ª–∏—Å—Ç"
        if self.paper:
            info += f" | –ú–∞—Ç–µ—Ä–∏–∞–ª: {self.formatted_material_price} –∑–∞ –ª–∏—Å—Ç"
        info += f" | –ò—Ç–æ–≥–æ: {self.formatted_total_circulation_price} –∑–∞ —Ç–∏—Ä–∞–∂"
        return info
    
    def recalculate_price(self):
        """
        –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω—É –∑–∞ –ª–∏—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∏–Ω—Ç–µ—Ä –∏ —Ç–∏—Ä–∞–∂).
        
        Returns:
            tuple: (bool —É—Å–ø–µ—Ö, str —Å–æ–æ–±—â–µ–Ω–∏–µ)
        """
        if self.printer and self.proschet and self.proschet.circulation:
            try:
                old_price = self.price_per_sheet
                # –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã
                calculated_price = self.calculate_price_for_printer_and_copies(
                    self.printer, 
                    self.proschet.circulation
                )
                self.price_per_sheet = calculated_price
                self.is_price_calculated = True
                self.save()  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                return True, f"–¶–µ–Ω–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞: {old_price} ‚Üí {calculated_price} —Ä—É–±./–ª–∏—Å—Ç"
            except Exception as e:
                return False, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ —Ü–µ–Ω—ã: {str(e)}"
        return False, "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–Ω—Ç–µ—Ä –∏–ª–∏ —Ç–∏—Ä–∞–∂"


class AdditionalWork(models.Model):
    """
    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º DR-.
    –ú–æ–¥–µ–ª—å –¥–ª—è —É—á–µ—Ç–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –æ—Å–Ω–æ–≤–Ω–æ–π –ø–µ—á–∞—Ç—å—é.
    """
    
    number = models.CharField(
        verbose_name='–ù–æ–º–µ—Ä —Ä–∞–±–æ—Ç—ã',
        max_length=20,
        unique=True,
        blank=True,
        help_text='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–∞ DR-1, DR-2 –∏ —Ç.–¥.'
    )
    
    proschet = models.ForeignKey(
        Proschet,
        verbose_name='–ü—Ä–æ—Å—á—ë—Ç',
        on_delete=models.CASCADE,  # –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ—Å—á–µ—Ç–∞
        related_name='additional_works',
        help_text='–ü—Ä–æ—Å—á—ë—Ç, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —ç—Ç–∞ —Ä–∞–±–æ—Ç–∞'
    )
    
    title = models.CharField(
        verbose_name='–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã',
        max_length=200,
        help_text='–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã'
    )
    
    price = models.DecimalField(
        verbose_name='–¶–µ–Ω–∞',
        max_digits=10,
        decimal_places=2,
        validators=[MinValueValidator(Decimal('0.00'))],
        help_text='–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –≤ —Ä—É–±–ª—è—Ö'
    )
    
    created_at = models.DateTimeField(
        verbose_name='–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è',
        auto_now_add=True,
        help_text='–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã'
    )
    
    is_deleted = models.BooleanField(
        verbose_name='–£–¥–∞–ª–µ–Ω',
        default=False,
        help_text='–ü–æ–º–µ—á–∞–µ—Ç —Ä–∞–±–æ—Ç—É –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—É—é'
    )
    
    class Meta:
        """–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
        verbose_name = '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞'
        verbose_name_plural = '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã'
        ordering = ['created_at']
    
    def __str__(self):
        """–°—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã"""
        return f"{self.number}: {self.title}"
    
    def save(self, *args, **kwargs):
        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –Ω–æ–º–µ—Ä–∞"""
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω
        if not self.number or self.number.strip() == '':
            try:
                # –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –Ω–æ–º–µ—Ä–æ–≤ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º DR-
                existing_numbers = AdditionalWork.objects.filter(
                    number__startswith='DR-'
                ).exclude(number__exact='').exclude(number__isnull=True).values_list('number', flat=True)
                
                max_num = 0
                
                # –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –Ω–æ–º–µ—Ä–æ–≤
                for num_str in existing_numbers:
                    try:
                        num_part = num_str.split('-')[1]
                        current_num = int(num_part)
                        if current_num > max_num:
                            max_num = current_num
                    except (ValueError, IndexError, AttributeError):
                        continue
                
                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞
                new_num = max_num + 1
                self.number = f"DR-{new_num}"
                
            except Exception as e:
                # Fallback-–º–µ—Ç–æ–¥ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                count = AdditionalWork.objects.count()
                self.number = f"DR-{count + 1}"
                print(f"‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω fallback –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ (AdditionalWork): {self.number}")
        
        # –í—ã–∑–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –º–µ—Ç–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        super().save(*args, **kwargs)