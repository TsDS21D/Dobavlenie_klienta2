<!--
index.html –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è sheet_formats
–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è sheet_formats —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π inline-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
–ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ base.html
-->

{% extends "sheet_formats/base.html" %}

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
{% block title %}–§–æ—Ä–º–∞—Ç—ã –ª–∏—Å—Ç–æ–≤{% endblock %}

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
{% block content %}
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º -->
    <h1>
        <img src="https://www.bukva-a.ru/uploads/logo/logo300.png" 
            alt="–¢–∏–ø–æ–≥—Ä–∞—Ñ–∏—è &quot;–ë—É–∫–≤–∞ –ê&quot;" 
            title="–¢–∏–ø–æ–≥—Ä–∞—Ñ–∏—è &quot;–ë—É–∫–≤–∞ –ê&quot;"
            width="150">
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –ø–µ—á–∞—Ç–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤
    </h1>
    
    <!-- –°–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π Django -->
    <div class="django-messages" style="display: none;">
        {% if messages %}
            {% for message in messages %}
                <div class="django-message" data-type="{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ -->
    <div class="form-toggle-section">
        <button type="button" id="toggle-form-btn" class="btn-toggle-form">
            –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç
        </button>
    </div>
    
    <!-- –°–µ–∫—Ü–∏—è —Å —Ñ–æ—Ä–º–æ–π –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
    <div class="form-section" id="format-form-section" style="display: none;">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç</h2>
        
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ -->
        <form method="post" action="{% url 'sheet_formats:index' %}" id="format-form">
            {% csrf_token %}
            
            <!-- –ü–æ–ª–µ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ -->
            <div class="form-group">
                <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                {{ form.name }}
                {% if form.name.errors %}
                    <div class="errorlist">{{ form.name.errors }}</div>
                {% endif %}
                <div class="help-text">{{ form.name.help_text }}</div>
            </div>
            
            <!-- –î–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —à–∏—Ä–∏–Ω—ã –∏ –≤—ã—Å–æ—Ç—ã -->
            <div class="dimensions-container">
                <!-- –ü–æ–ª–µ –¥–ª—è —à–∏—Ä–∏–Ω—ã –ª–∏—Å—Ç–∞ -->
                <div class="form-group dimension-group">
                    <label for="{{ form.width_mm.id_for_label }}">{{ form.width_mm.label }}</label>
                    {{ form.width_mm }}
                    {% if form.width_mm.errors %}
                        <div class="errorlist">{{ form.width_mm.errors }}</div>
                    {% endif %}
                    <div class="help-text">{{ form.width_mm.help_text }}</div>
                </div>
                
                <!-- –ü–æ–ª–µ –¥–ª—è –≤—ã—Å–æ—Ç—ã –ª–∏—Å—Ç–∞ -->
                <div class="form-group dimension-group">
                    <label for="{{ form.height_mm.id_for_label }}">{{ form.height_mm.label }}</label>
                    {{ form.height_mm }}
                    {% if form.height_mm.errors %}
                        <div class="errorlist">{{ form.height_mm.errors }}</div>
                    {% endif %}
                    <div class="help-text">{{ form.height_mm.help_text }}</div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ —Ñ–æ—Ä–º—ã -->
            <div class="button-group">
                <button type="submit" class="btn-submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç</button>
                <button type="reset" class="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
            </div>
        </form>
    </div>
    
    <!-- –°–µ–∫—Ü–∏—è —Å–æ —Å–ø–∏—Å–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–æ–≤ -->
    <div class="printers-section">
        <h2>–°–ø–∏—Å–æ–∫ —Ñ–æ—Ä–º–∞—Ç–æ–≤ ({{ formats|length }})</h2>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤ –Ω–µ—Ç -->
        {% if not formats %}
            <div class="empty-message">
                –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç —Ñ–æ—Ä–º–∞—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç" –≤—ã—à–µ.
            </div>
        {% else %}
            <!-- –¢–∞–±–ª–∏—Ü–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–æ–≤ -->
            <div class="printers-table">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã -->
                <div class="table-header">
                    <div class="col-name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞</div>
                    <div class="col-dimensions">–†–∞–∑–º–µ—Ä—ã</div>
                    <div class="col-actions">–î–µ–π—Å—Ç–≤–∏—è</div>
                </div>
                
                <!-- –¶–∏–∫–ª –ø–æ –≤—Å–µ–º —Ñ–æ—Ä–º–∞—Ç–∞–º –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö -->
                {% for format in formats %}
                    <!-- –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã —Å –¥–≤—É–º—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ -->
                    <div class="table-row" 
                        data-format-id="{{ format.id }}" 
                        id="format-row-{{ format.id }}">
                        
                        <!-- –ö–æ–ª–æ–Ω–∫–∞: –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ -->
                        <div class="col-name">
                            <!-- –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
                            <div class="view-mode editable-field" data-field="name">
                                <div class="printer-name">{{ format.name }}</div>
                            </div>
                            
                            <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                            <div class="edit-mode" style="display: none;">
                                <input type="text" 
                                    name="name" 
                                    value="{{ format.name }}" 
                                    class="edit-input"
                                    data-field="name"
                                    placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞">
                            </div>
                        </div>
                        
                        <!-- –ö–æ–ª–æ–Ω–∫–∞: –†–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–∞ -->
                        <div class="col-dimensions">
                            <!-- –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
                            <div class="view-mode editable-field" data-field="dimensions">
                                <span class="param-badge">{{ format.get_dimensions_display }}</span>
                            </div>
                            
                            <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                            <div class="edit-mode" style="display: none;">
                                <div class="dimensions-inputs">
                                    <input type="number" 
                                        name="width_mm" 
                                        value="{{ format.width_mm }}" 
                                        class="edit-input edit-number"
                                        data-field="width_mm"
                                        placeholder="–®–∏—Ä–∏–Ω–∞"
                                        min="1"
                                        step="1">
                                    <span class="dimensions-separator">√ó</span>
                                    <input type="number" 
                                        name="height_mm" 
                                        value="{{ format.height_mm }}" 
                                        class="edit-input edit-number"
                                        data-field="height_mm"
                                        placeholder="–í—ã—Å–æ—Ç–∞"
                                        min="1"
                                        step="1">
                                    <span class="dimensions-unit">–º–º</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ö–æ–ª–æ–Ω–∫–∞: –î–µ–π—Å—Ç–≤–∏—è -->
                        <div class="col-actions">
                            <!-- –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
                            <div class="view-mode">
                                <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º -->
                                <a href="{% url 'sheet_formats:delete_format' format.id %}" 
                                class="btn-action btn-delete"
                                onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç \"{{ format.name }}\" ({{ format.get_dimensions_display }})?');">
                                    –£–¥–∞–ª–∏—Ç—å
                                </a>
                            </div>
                            
                            <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                            <div class="edit-mode edit-actions" style="display: none;">
                                <button type="button" class="btn-action btn-save" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è">
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </button>
                                <button type="button" class="btn-action btn-cancel" title="–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="table-hint">
                <div class="hint-item">
                    <span class="hint-icon">üñ±Ô∏è</span>
                    <span class="hint-text">–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —è—á–µ–π–∫–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
                </div>
                <div class="hint-item">
                    <span class="hint-icon">üíæ</span>
                    <span class="hint-text">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–û—Ç–º–µ–Ω–∞"</span>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π JavaScript -->
{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
let currentEditRow = null;
let originalData = {};

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞.
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç" –∏ "–ó–∞–∫—Ä—ã—Ç—å".
 */
function toggleForm() {
    const formSection = document.getElementById('format-form-section');
    const toggleButton = document.getElementById('toggle-form-btn');
    
    if (formSection.style.display === 'none') {
        // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ —Å–∫—Ä—ã—Ç–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–µ
        formSection.style.display = 'block';
        toggleButton.textContent = '–°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É';
        toggleButton.classList.add('active');
    } else {
        // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ - —Å–∫—Ä—ã–≤–∞–µ–º –µ–µ
        formSection.style.display = 'none';
        toggleButton.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç';
        toggleButton.classList.remove('active');
    }
}

/**
 * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 * 
 * @param {HTMLElement} row - –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
 * @param {string} fieldName - –ò–º—è –ø–æ–ª—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –∫–ª–∏–∫–Ω—É–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
 */
function enableEditMode(row, fieldName = null) {
    const formatId = row.dataset.formatId;
    
    console.log(`DEBUG: –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ ${formatId}`);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–∫—É—â—É—é —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—É—é —Å—Ç—Ä–æ–∫—É
    currentEditRow = row;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    saveOriginalData(row);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    row.querySelectorAll('.view-mode').forEach(el => {
        el.style.display = 'none';
    });
    
    row.querySelectorAll('.edit-mode').forEach(el => {
        el.style.display = '';
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
    row.classList.add('edit-mode-active');
    
    // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø–æ–ª–µ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞ –Ω–µ–≥–æ —Ñ–æ–∫—É—Å
    if (fieldName && fieldName !== 'dimensions') {
        const input = row.querySelector(`.edit-mode [data-field="${fieldName}"]`);
        if (input) {
            setTimeout(() => input.focus(), 50);
        }
    } else if (fieldName === 'dimensions') {
        // –î–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–æ–ª–µ (—à–∏—Ä–∏–Ω–µ)
        const widthInput = row.querySelector(`.edit-mode [data-field="width_mm"]`);
        if (widthInput) {
            setTimeout(() => widthInput.focus(), 50);
        }
    }
}

/**
 * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏.
 * 
 * @param {HTMLElement} row - –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
 */
function saveOriginalData(row) {
    originalData = {};
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
    const inputs = row.querySelectorAll('.edit-mode .edit-input');
    inputs.forEach(input => {
        originalData[input.dataset.field] = input.value;
    });
    
    // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const nameElement = row.querySelector('.col-name .printer-name');
    if (nameElement) {
        originalData.nameDisplay = nameElement.textContent;
    }
    
    const dimensionsElement = row.querySelector('.col-dimensions .param-badge');
    if (dimensionsElement) {
        originalData.dimensionsDisplay = dimensionsElement.textContent;
    }
}

/**
 * –í—ã—Ö–æ–¥–∏—Ç –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
 * 
 * @param {HTMLElement} row - –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
 */
function cancelEditMode(row) {
    const formatId = row.dataset.formatId;
    
    console.log(`DEBUG: –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ ${formatId}`);
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
    Object.keys(originalData).forEach(fieldName => {
        if (fieldName !== 'nameDisplay' && fieldName !== 'dimensionsDisplay') {
            const input = row.querySelector(`.edit-mode [data-field="${fieldName}"]`);
            if (input) {
                input.value = originalData[fieldName];
            }
        }
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞, —Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    row.querySelectorAll('.view-mode').forEach(el => {
        el.style.display = '';
    });
    
    row.querySelectorAll('.edit-mode').forEach(el => {
        el.style.display = 'none';
    });
    
    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    row.classList.remove('edit-mode-active');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    currentEditRow = null;
    originalData = {};
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
 * 
 * @param {HTMLElement} row - –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
 */
function saveEditForm(row) {
    const formatId = row.dataset.formatId;
    
    console.log(`DEBUG: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ ${formatId}`);
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
    const data = {
        'name': row.querySelector('.edit-mode [name="name"]').value.trim(),
        'width_mm': parseInt(row.querySelector('.edit-mode [name="width_mm"]').value) || 0,
        'height_mm': parseInt(row.querySelector('.edit-mode [name="height_mm"]').value) || 0,
    };
    
    console.log(`DEBUG: –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:`, data);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    if (!data.name || data.name.length < 2) {
        showNotification('error', '–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
        return;
    }
    
    if (data.width_mm <= 0 || data.height_mm <= 0) {
        showNotification('error', '–®–∏—Ä–∏–Ω–∞ –∏ –≤—ã—Å–æ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏');
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     document.querySelector('meta[name="csrf-token"]')?.content;
    
    if (!csrfToken) {
        console.error('CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
        showNotification('error', '–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–Ω–∫–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≤ —Å–∞–º–æ–π —Å—Ç—Ä–æ–∫–µ (–≤–º–µ—Å—Ç–æ –≤—Å–µ–≥–æ —ç–∫—Ä–∞–Ω–∞)
    showRowLoadingIndicator(row);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX-–∑–∞–ø—Ä–æ—Å
    fetch(`/sheet_formats/update/${formatId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        console.log(`DEBUG: –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å: ${response.status}`);
        return response.json().then(data => ({
            status: response.status,
            ok: response.ok,
            data: data
        }));
    })
    .then(result => {
        console.log(`DEBUG: –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:`, result);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–æ–∫–∏
        hideRowLoadingIndicator(row);
        
        if (result.ok && result.data.success) {
            // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            updateViewRow(row, result.data.format);
            
            // –ó–∞—Ç–µ–º –ø–ª–∞–≤–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            setTimeout(() => {
                switchToViewMode(row);
            }, 100);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            showNotification('success', result.data.message);
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            if (result.data.errors) {
                showValidationErrors(row, result.data.errors);
            }
            showNotification('error', result.data.message || `–û—à–∏–±–∫–∞ ${result.status}`);
        }
    })
    .catch(error => {
        hideRowLoadingIndicator(row);
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
        showNotification('error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    });
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
 * 
 * @param {HTMLElement} row - –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
 * @param {Object} formatData - –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç–∞
 */
function updateViewRow(row, formatData) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞
    const nameElement = row.querySelector('.col-name .printer-name');
    if (nameElement) {
        nameElement.textContent = formatData.name;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–∞
    const dimensionsElement = row.querySelector('.col-dimensions .param-badge');
    if (dimensionsElement) {
        dimensionsElement.textContent = formatData.dimensions_display;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞ (–Ω–∞ —Å–ª—É—á–∞–π –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    const nameInput = row.querySelector('.edit-mode [name="name"]');
    if (nameInput) {
        nameInput.value = formatData.name;
    }
    
    const widthInput = row.querySelector('.edit-mode [name="width_mm"]');
    if (widthInput) {
        widthInput.value = formatData.width_mm;
    }
    
    const heightInput = row.querySelector('.edit-mode [name="height_mm"]');
    if (heightInput) {
        heightInput.value = formatData.height_mm;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É —É–¥–∞–ª–µ–Ω–∏—è
    const deleteLink = row.querySelector('.btn-delete');
    if (deleteLink) {
        deleteLink.onclick = function() {
            return confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç "${formatData.name}" (${formatData.dimensions_display})?`);
        };
    }
}

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ —Å—Ç—Ä–æ–∫–µ.
 * 
 * @param {HTMLElement} row - –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
 * @param {Object} errors - –û–±—ä–µ–∫—Ç —Å –æ—à–∏–±–∫–∞–º–∏
 */
function showValidationErrors(row, errors) {
    // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
    row.querySelectorAll('.error-message').forEach(el => el.remove());
    row.querySelectorAll('.edit-input').forEach(input => {
        input.classList.remove('error');
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –æ—à–∏–±–∫–∏
    if (errors) {
        Object.keys(errors).forEach(fieldName => {
            let input;
            
            // –î–ª—è –ø–æ–ª—è dimensions –∏—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è width_mm –∏–ª–∏ height_mm
            if (fieldName === 'dimensions') {
                input = row.querySelector(`.edit-mode [data-field="width_mm"]`);
            } else {
                input = row.querySelector(`.edit-mode [data-field="${fieldName}"]`);
            }
            
            if (input) {
                input.classList.add('error');
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = Array.isArray(errors[fieldName]) ? 
                    errors[fieldName].join(', ') : errors[fieldName];
                
                input.parentNode.appendChild(errorDiv);
            }
        });
    }
}

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.
 * 
 * @param {string} type - –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (success, error, info)
 * @param {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
 */
function showNotification(type, message) {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    // –ù–∞—á–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateX(100%);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
        max-width: 400px;
    `;
    
    // –¶–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    if (type === 'success') {
        notification.style.backgroundColor = '#4caf50';
        notification.style.borderLeft = '4px solid #2e7d32';
    } else if (type === 'error') {
        notification.style.backgroundColor = '#f44336';
        notification.style.borderLeft = '4px solid #c62828';
    } else {
        notification.style.backgroundColor = '#2196f3';
        notification.style.borderLeft = '4px solid #0d47a1';
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    const messagesContainer = document.querySelector('.messages');
    if (messagesContainer) {
        messagesContainer.appendChild(notification);
    } else {
        document.body.appendChild(notification);
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 10);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 5000);
}

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏.
 */
function showLoadingIndicator() {
    const loadingIndicator = document.createElement('div');
    loadingIndicator.id = 'loading-indicator';
    loadingIndicator.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        font-size: 1.2rem;
        color: #0B8661;
    `;
    
    loadingIndicator.innerHTML = `
        <div style="margin-bottom: 1rem;">‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π...</div>
        <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #0B8661; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    `;
    
    document.body.appendChild(loadingIndicator);
}

/**
 * –£–¥–∞–ª—è–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏.
 */
function hideLoadingIndicator() {
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator && loadingIndicator.parentNode) {
        loadingIndicator.remove();
    }
}

/**
 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è Django –≤ notification
 */
function convertDjangoMessagesToNotifications() {
    const djangoMessages = document.querySelectorAll('.django-message');
    
    djangoMessages.forEach(msg => {
        const type = msg.dataset.type || 'info';
        const message = msg.textContent.trim(); // –ë–µ—Ä–µ–º —Ç–µ–∫—Å—Ç –Ω–∞–ø—Ä—è–º—É—é
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ notification
        showNotification(type, message);
        
        // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
        msg.remove();
    });
    
    // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç
    const container = document.querySelector('.django-messages');
    if (container && container.children.length === 0) {
        container.remove();
    }
}

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
 */
function showNotification(type, message) {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}


/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
 */
document.addEventListener('DOMContentLoaded', function() {
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è Django –≤ notification
    convertDjangoMessagesToNotifications();
    const toggleButton = document.getElementById('toggle-form-btn');
    
    if (toggleButton) {
        toggleButton.addEventListener('click', toggleForm);
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –≤ —Ñ–æ—Ä–º–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    const errorMessages = document.querySelectorAll('.errorlist');
    if (errorMessages.length > 0) {
        toggleForm();
    }
    
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –î–í–û–ô–ù–û–ì–û –∫–ª–∏–∫–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è
    document.querySelectorAll('.editable-field').forEach(field => {
        field.addEventListener('dblclick', function(e) {
            // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–≤–æ–π–Ω—ã–µ –∫–ª–∏–∫–∏, –µ—Å–ª–∏ —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            if (currentEditRow) return;
            
            const row = this.closest('.table-row');
            const fieldName = this.dataset.field;
            
            if (row) {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                setTimeout(() => {
                    enableEditMode(row, fieldName);
                }, 50);
            }
        });
    });
    
    // –û—Å—Ç–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–¥–∏–Ω–∞—Ä–Ω–æ–≥–æ –∫–ª–∏–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
    document.querySelectorAll('.table-row').forEach(row => {
        // –û–¥–∏–Ω–∞—Ä–Ω—ã–π –∫–ª–∏–∫ - –≤—ã–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É (–µ—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        row.addEventListener('click', function(e) {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö –∏ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
            if (e.target.closest('.btn-action') || 
                e.target.closest('.edit-input') || 
                currentEditRow) {
                return;
            }
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–æ–∫
            document.querySelectorAll('.table-row.selected').forEach(otherRow => {
                if (otherRow !== this) {
                    otherRow.classList.remove('selected');
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º/—É–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
            this.classList.toggle('selected');
        });
    });
    
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ—Ç–º–µ–Ω—ã
    document.querySelectorAll('.btn-cancel').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('.table-row');
            if (row) {
                cancelEditMode(row);
            }
        });
    });
    
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    document.querySelectorAll('.btn-save').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('.table-row');
            if (row) {
                saveEditForm(row);
            }
        });
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–ª–∞–≤–∏—à–∏ Escape –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && currentEditRow) {
            cancelEditMode(currentEditRow);
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ Ctrl+Enter
        if (e.key === 'Enter' && e.ctrlKey && currentEditRow) {
            saveEditForm(currentEditRow);
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.ctrlKey && currentEditRow) {
            const activeElement = document.activeElement;
            if (activeElement && activeElement.classList.contains('edit-input')) {
                e.preventDefault();
                saveEditForm(currentEditRow);
            }
        }
    });
    
});

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏.
 * 
 * @param {HTMLElement} row - –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
 */
function showRowLoadingIndicator(row) {
    // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å
    hideRowLoadingIndicator(row);
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'row-loading-indicator';
    loadingDiv.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 4px;
    `;
    
    loadingDiv.innerHTML = `
        <div style="
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0B8661;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        "></div>
    `;
    
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç
    row.style.position = 'relative';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ —Å—Ç—Ä–æ–∫—É
    row.appendChild(loadingDiv);
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
    row.querySelectorAll('button').forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'wait';
    });
}

/**
 * –£–±–∏—Ä–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏.
 * 
 * @param {HTMLElement} row - –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
 */
function hideRowLoadingIndicator(row) {
    const indicator = row.querySelector('.row-loading-indicator');
    if (indicator) {
        indicator.remove();
    }
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
    row.querySelectorAll('button').forEach(btn => {
        btn.disabled = false;
        btn.style.opacity = '';
        btn.style.cursor = '';
    });
}

/**
 * –ü–ª–∞–≤–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.
 * 
 * @param {HTMLElement} row - –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
 */
function switchToViewMode(row) {
    // –°–Ω–∞—á–∞–ª–∞ –ø–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    row.querySelectorAll('.edit-mode').forEach(el => {
        el.style.opacity = '0';
        setTimeout(() => {
            el.style.display = 'none';
            el.style.opacity = '';
        }, 200);
    });
    
    // –ó–∞—Ç–µ–º –ø–ª–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    setTimeout(() => {
        row.querySelectorAll('.view-mode').forEach(el => {
            el.style.display = '';
            el.style.opacity = '0';
            setTimeout(() => {
                el.style.opacity = '1';
            }, 10);
        });
        
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        row.classList.remove('edit-mode-active');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        currentEditRow = null;
        originalData = {};
    }, 200);
}

/**
 * –ü–ª–∞–≤–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 * 
 * @param {HTMLElement} row - –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
 * @param {string} fieldName - –ò–º—è –ø–æ–ª—è –¥–ª—è —Ñ–æ–∫—É—Å–∞
 */
function enableEditMode(row, fieldName = null) {
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –¥–≤–æ–π–Ω—ã—Ö –∫–ª–∏–∫–∞—Ö
    if (row.classList.contains('entering-edit-mode')) {
        return;
    }
    
    row.classList.add('entering-edit-mode');
    
    const formatId = row.dataset.formatId;
    
    console.log(`DEBUG: –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ ${formatId}`);
    
    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ —Å—Ç—Ä–æ–∫–∏
    row.classList.remove('selected');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–∫—É—â—É—é —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—É—é —Å—Ç—Ä–æ–∫—É
    currentEditRow = row;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    saveOriginalData(row);
    
    // –ü–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    row.querySelectorAll('.view-mode').forEach(el => {
        el.style.opacity = '0';
        setTimeout(() => {
            el.style.display = 'none';
            el.style.opacity = '';
        }, 150);
    });
    
    // –ü–ª–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    setTimeout(() => {
        row.querySelectorAll('.edit-mode').forEach(el => {
            el.style.display = '';
            el.style.opacity = '0';
            setTimeout(() => {
                el.style.opacity = '1';
            }, 10);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
        row.classList.add('edit-mode-active');
        
        // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø–æ–ª–µ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞ –Ω–µ–≥–æ —Ñ–æ–∫—É—Å
        if (fieldName && fieldName !== 'dimensions') {
            const input = row.querySelector(`.edit-mode [data-field="${fieldName}"]`);
            if (input) {
                setTimeout(() => {
                    input.focus();
                    input.select(); // –í—ã–¥–µ–ª—è–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                }, 200);
            }
        } else if (fieldName === 'dimensions') {
            const widthInput = row.querySelector(`.edit-mode [data-field="width_mm"]`);
            if (widthInput) {
                setTimeout(() => {
                    widthInput.focus();
                    widthInput.select();
                }, 200);
            }
        }
        
        // –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        setTimeout(() => {
            row.classList.remove('entering-edit-mode');
        }, 500);
        
    }, 150);
}

/**
 * –ü–ª–∞–≤–Ω–æ –æ—Ç–º–µ–Ω—è–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.
 * 
 * @param {HTMLElement} row - –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
 */
function cancelEditMode(row) {
    const formatId = row.dataset.formatId;
    
    console.log(`DEBUG: –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ ${formatId}`);
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    Object.keys(originalData).forEach(fieldName => {
        if (fieldName !== 'nameDisplay' && fieldName !== 'dimensionsDisplay') {
            const input = row.querySelector(`.edit-mode [data-field="${fieldName}"]`);
            if (input) {
                input.value = originalData[fieldName];
            }
        }
    });
    
    // –ü–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    row.querySelectorAll('.edit-mode').forEach(el => {
        el.style.opacity = '0';
        setTimeout(() => {
            el.style.display = 'none';
            el.style.opacity = '';
        }, 150);
    });
    
    // –ü–ª–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    setTimeout(() => {
        row.querySelectorAll('.view-mode').forEach(el => {
            el.style.display = '';
            el.style.opacity = '0';
            setTimeout(() => {
                el.style.opacity = '1';
            }, 10);
        });
        
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        row.classList.remove('edit-mode-active');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        currentEditRow = null;
        originalData = {};
    }, 150);
}


/**
 * –í—ã–¥–µ–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã
 * 
 * @param {HTMLElement} row - –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
 */
function selectRow(row) {
    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
    document.querySelectorAll('.table-row.selected').forEach(otherRow => {
        if (otherRow !== row) {
            otherRow.classList.remove('selected');
        }
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–µ
    row.classList.add('selected');
}

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ—Å–µ—â–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (!localStorage.getItem('sheet_formats_hint_shown')) {
        setTimeout(() => {
            showNotification('info', 'üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Å–¥–µ–ª–∞–π—Ç–µ –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —è—á–µ–π–∫–µ –≤ —Ç–∞–±–ª–∏—Ü–µ');
            localStorage.setItem('sheet_formats_hint_shown', 'true');
        }, 1000);
    }

</script>
{% endblock %}