"""
consumers.py
WebSocket –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏ —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∏.
–û–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é —Å–≤—è–∑—å –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–æ–º –∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏ —á–µ—Ä–µ–∑ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.
"""

import json  # –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON —Ñ–æ—Ä–º–∞—Ç–æ–º (—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è)
from channels.generic.websocket import AsyncWebsocketConsumer  # –ë–∞–∑–æ–≤—ã–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è WebSocket
from channels.db import database_sync_to_async  # –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –ë–î –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–¥–µ
from django.contrib.auth.models import AnonymousUser  # –ö–ª–∞—Å—Å –¥–ª—è –Ω–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
from .models import Order  # –ò–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–∏ Order –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–∫–∞–∑–∞–º–∏
from django.utils import timezone  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏ –∏ –≤—Ä–µ–º–µ–Ω–µ–º —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤


class OrderConsumer(AsyncWebsocketConsumer):
    """
    OrderConsumer - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏.
    –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç AsyncWebsocketConsumer –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞.
    
    –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:
    - connect: –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
    - disconnect: –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    - receive: –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
    - order_update: –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º –≤ –≥—Ä—É–ø–ø–µ
    
    –û—Å–Ω–æ–≤–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã:
    - room_group_name: –∏–º—è –≥—Ä—É–ø–ø—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º
    - channel_name: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–∞–Ω–∞–ª–∞ —ç—Ç–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    """
    
    async def connect(self):
        """
        –ú–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ—Ç –±—Ä–∞—É–∑–µ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞.
        –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.
        
        –®–∞–≥–∏:
        1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        2. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω - –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        3. –ï—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –≥—Ä—É–ø–ø—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        """
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ scope (–æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
        # scope —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ request –≤ HTTP
        user = self.scope.get('user')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        # isinstance(user, AnonymousUser) –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–Ω–æ–Ω–∏–º–Ω—ã–º
        # not user.is_authenticated –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø—Ä–æ—à–ª–∞ –ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        if isinstance(user, AnonymousUser) or not user.is_authenticated:
            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            # 4001 - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥ –æ—à–∏–±–∫–∏ "–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø"
            print(f"‚ùå WebSocket: –û—Ç–∫–∞–∑ –≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –¥–ª—è –Ω–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
            await self.close(code=4001)
            return
        
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        print(f"‚úÖ WebSocket: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.username}")
        
        # –ò–º—è –≥—Ä—É–ø–ø—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º
        # –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –Ω–∞ —ç—Ç—É –≥—Ä—É–ø–ø—É, –ø–æ–ª—É—á–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≤—Å–µ–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
        self.room_group_name = 'orders'
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (–∫–∞–Ω–∞–ª) –≤ –≥—Ä—É–ø–ø—É –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
        # self.channel_name - —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –∫–∞–Ω–∞–ª–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        await self.channel_layer.group_add(
            self.room_group_name,  # –ò–º—è –≥—Ä—É–ø–ø—ã, –≤ –∫–æ—Ç–æ—Ä—É—é –¥–æ–±–∞–≤–ª—è–µ–º
            self.channel_name      # –ò–º—è –∫–∞–Ω–∞–ª–∞ —ç—Ç–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        )
        
        # –ü—Ä–∏–Ω–∏–º–∞–µ–º WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        # –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç –∏ —Å–µ—Ä–≤–µ—Ä –º–æ–≥—É—Ç –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        await self.accept()
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ database_sync_to_async
        active_orders, completed_orders = await self.get_orders_by_status()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—É –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        # text_data - —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
        await self.send(text_data=json.dumps({
            'type': 'initial_load',           # –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            'active_orders': active_orders,    # –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (—Å–ª–æ–≤–∞—Ä–∏)
            'completed_orders': completed_orders  # –°–ø–∏—Å–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (—Å–ª–æ–≤–∞—Ä–∏)
        }))
    
    async def disconnect(self, close_code):
        """
        –ú–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è).
        
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - close_code: –∫–æ–¥ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞)
        
        –ó–¥–µ—Å—å –º—ã —É–¥–∞–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –≥—Ä—É–ø–ø—ã, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—è
        –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã.
        """
        
        # –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–∑ –≥—Ä—É–ø–ø—ã
        await self.channel_layer.group_discard(
            self.room_group_name,  # –ò–º—è –≥—Ä—É–ø–ø—ã, –∏–∑ –∫–æ—Ç–æ—Ä–æ–π —É–¥–∞–ª—è–µ–º
            self.channel_name      # –ò–º—è –∫–∞–Ω–∞–ª–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        )
        
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        print(f"üîå WebSocket: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ–¥: {close_code}")
    
    async def receive(self, text_data):
        """
        –ú–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ WebSocket.
        
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - text_data: —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–æ–±—ã—á–Ω–æ —Å—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON)
        
        –ó–¥–µ—Å—å –º—ã:
        1. –ü–∞—Ä—Å–∏–º JSON —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ª–æ–≤–∞—Ä—å Python
        2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è (action) –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        3. –í—ã–ø–æ–ª–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é —Å –∑–∞–∫–∞–∑–æ–º
        4. –†–∞—Å—Å—ã–ª–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º –≤ –≥—Ä—É–ø–ø–µ
        """
        
        # –ü–∞—Ä—Å–∏–º JSON —Å—Ç—Ä–æ–∫—É –≤ —Å–ª–æ–≤–∞—Ä—å Python –¥–ª—è —É–¥–æ–±–Ω–æ–π —Ä–∞–±–æ—Ç—ã
        # json.loads() –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å—Ç—Ä–æ–∫—É JSON –≤ –æ–±—ä–µ–∫—Ç Python
        data = json.loads(text_data)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        # data.get('action') –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª—é—á–∞ 'action' –∏–ª–∏ None, –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç
        action = data.get('action')
        
        # ===== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ù–û–í–û–ì–û –ó–ê–ö–ê–ó–ê =====
        if action == 'add_order':
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –Ω–æ–≤–æ–º –∑–∞–∫–∞–∑–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
            customer_name = data.get('customer_name')      # –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ (—Å—Ç—Ä–æ–∫–∞)
            description = data.get('description')          # –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (—Å—Ç—Ä–æ–∫–∞)
            ready_datetime_str = data.get('ready_datetime')  # –î–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (—Å—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            # –°—Ç–∞—Ç—É—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±—É–¥–µ—Ç 'accepted' (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤ –º–æ–¥–µ–ª–∏ Order)
            await self.add_order(customer_name, description, ready_datetime_str)
            
            # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –∑–∞–∫–∞–∑–æ–≤ (–∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ)
            active_orders, completed_orders = await self.get_orders_by_status()
            
            # –†–∞—Å—Å—ã–ª–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –í–°–ï–ú –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º –≤ –≥—Ä—É–ø–ø–µ
            # group_send –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –≥—Ä—É–ø–ø—ã
            await self.channel_layer.group_send(
                self.room_group_name,  # –ò–º—è –≥—Ä—É–ø–ø—ã –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
                {
                    'type': 'order_update',      # –¢–∏–ø —Å–æ–±—ã—Ç–∏—è (–≤—ã–∑–æ–≤–µ—Ç –º–µ—Ç–æ–¥ order_update)
                    'active_orders': active_orders,    # –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã
                    'completed_orders': completed_orders  # –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
                }
            )
        
        # ===== –£–î–ê–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê =====
        elif action == 'delete_order':
            # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
            order_number = data.get('order_number')  # –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ —á–∏—Å–ª–æ)
            
            # –£–¥–∞–ª—è–µ–º –∑–∞–∫–∞–∑ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            await self.delete_order(order_number)
            
            # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –∑–∞–∫–∞–∑–æ–≤
            active_orders, completed_orders = await self.get_orders_by_status()
            
            # –†–∞—Å—Å—ã–ª–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
            await self.channel_layer.group_send(
                self.room_group_name,
                {
                    'type': 'order_update',
                    'active_orders': active_orders,
                    'completed_orders': completed_orders
                }
            )
        
        # ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê (–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï) =====
        elif action == 'update_order':
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
            order_number = data.get('order_number')        # –ù–æ–º–µ—Ä –∏–∑–º–µ–Ω—è–µ–º–æ–≥–æ –∑–∞–∫–∞–∑–∞
            customer_name = data.get('customer_name')      # –ù–æ–≤–æ–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
            description = data.get('description')          # –ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
            ready_datetime_str = data.get('ready_datetime')  # –ù–æ–≤–∞—è –¥–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            await self.update_order(order_number, customer_name, description, ready_datetime_str)
            
            # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –∑–∞–∫–∞–∑–æ–≤
            active_orders, completed_orders = await self.get_orders_by_status()
            
            # –†–∞—Å—Å—ã–ª–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
            await self.channel_layer.group_send(
                self.room_group_name,
                {
                    'type': 'order_update',
                    'active_orders': active_orders,
                    'completed_orders': completed_orders
                }
            )
        
        # ===== –ò–ó–ú–ï–ù–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –ó–ê–ö–ê–ó–ê =====
        elif action == 'change_status':
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –∏ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
            order_number = data.get('order_number')  # –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
            new_status = data.get('status')          # –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å ('accepted', 'in_progress', 'ready', 'completed')
            
            # –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            await self.change_order_status(order_number, new_status)
            
            # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –∑–∞–∫–∞–∑–æ–≤
            active_orders, completed_orders = await self.get_orders_by_status()
            
            # –†–∞—Å—Å—ã–ª–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
            await self.channel_layer.group_send(
                self.room_group_name,
                {
                    'type': 'order_update',
                    'active_orders': active_orders,
                    'completed_orders': completed_orders
                }
            )
        
        # ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –ó–ê–ö–ê–ó–û–í (–ü–ï–†–ï–°–ß–Å–¢ –†–ê–ë–û–ß–ò–• –ß–ê–°–û–í) =====
        elif action == 'refresh_orders':
            # –ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–∏–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞ —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤)
            # –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ –∏–ª–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É –∫–ª–∏–µ–Ω—Ç–∞
            
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å–ø–∏—Å–∫–∏ –∑–∞–∫–∞–∑–æ–≤
            active_orders, completed_orders = await self.get_orders_by_status()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —ç—Ç–æ–º—É –∫–ª–∏–µ–Ω—Ç—É (–Ω–µ –≤—Å–µ–π –≥—Ä—É–ø–ø–µ)
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º self.send –≤–º–µ—Å—Ç–æ group_send –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é
            await self.send(text_data=json.dumps({
                'type': 'order_update',           # –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
                'active_orders': active_orders,    # –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã
                'completed_orders': completed_orders  # –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
            }))
        
        # ===== –ù–ï–ò–ó–í–ï–°–¢–ù–û–ï –î–ï–ô–°–¢–í–ò–ï =====
        else:
            # –ï—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ, –ª–æ–≥–∏—Ä—É–µ–º —ç—Ç–æ
            print(f"‚ö†Ô∏è WebSocket: –ü–æ–ª—É—á–µ–Ω–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: {action}")
    
    async def order_update(self, event):
        """
        –ú–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É (—á–µ—Ä–µ–∑ group_send).
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É, –≤—ã–∑–≤–∞–≤—à–µ–º—É —ç—Ç–æ—Ç –º–µ—Ç–æ–¥.
        
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - event: —Å–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –≤ group_send
        
        –ú–µ—Ç–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ –ø—Ä–∏ group_send.
        """
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–±—ã—Ç–∏—è event
        # event - —ç—Ç–æ —Ç–æ—Ç –∂–µ —Å–ª–æ–≤–∞—Ä—å, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω –≤ group_send
        active_orders = event['active_orders']        # –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        completed_orders = event['completed_orders']  # –°–ø–∏—Å–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
        await self.send(text_data=json.dumps({
            'type': 'order_update',           # –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
            'active_orders': active_orders,    # –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã
            'completed_orders': completed_orders  # –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
        }))
    
    # ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–• =====
    # –≠—Ç–∏ –º–µ—Ç–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä @database_sync_to_async –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º ORM Django
    # –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ WebSocket
    
    @database_sync_to_async
    def add_order(self, customer_name, description, ready_datetime_str):
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
        
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - customer_name: –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ (—Å—Ç—Ä–æ–∫–∞)
        - description: –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (—Å—Ç—Ä–æ–∫–∞)
        - ready_datetime_str: —Å—Ç—Ä–æ–∫–∞ —Å –¥–∞—Ç–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO (YYYY-MM-DDTHH:MM)
        
        –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç Order –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ –ë–î.
        –°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'accepted').
        –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (AutoField).
        """
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã –≤ –æ–±—ä–µ–∫—Ç datetime
        # fromisoformat() –ø–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO (–Ω–∞–ø—Ä–∏–º–µ—Ä: "2023-12-15T14:30")
        ready_dt_naive = timezone.datetime.fromisoformat(ready_datetime_str)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –¥–∞—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ (timezone-aware)
        # –ï—Å–ª–∏ datetime "–Ω–∞–∏–≤–Ω—ã–π" (–±–µ–∑ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞), –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
        if ready_dt_naive.tzinfo is None:
            # –î–µ–ª–∞–µ–º datetime "–æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–º" (aware) —Å —Ç–µ–∫—É—â–∏–º —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º Django
            ready_dt = timezone.make_aware(ready_dt_naive)
        else:
            ready_dt = ready_dt_naive
        
        # –°–æ–∑–¥–∞—ë–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        # Order.objects.create() —Å–æ–∑–¥–∞—ë—Ç –æ–±—ä–µ–∫—Ç Order –∏ —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ –ë–î
        order = Order.objects.create(
            customer_name=customer_name,
            description=description,
            ready_datetime=ready_dt
            # –°—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∫ 'accepted' (default –≤ –º–æ–¥–µ–ª–∏)
            # –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (AutoField)
        )
        
        # –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        print(f"üìù –°–æ–∑–¥–∞–Ω –∑–∞–∫–∞–∑ ‚Ññ{order.order_number} –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ {customer_name}")
        
        return order  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç Order (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    
    @database_sync_to_async
    def update_order(self, order_number, customer_name, description, ready_datetime_str):
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∑–∞–∫–∞–∑ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
        
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - order_number: –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ —á–∏—Å–ª–æ)
        - customer_name: –Ω–æ–≤–æ–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ (—Å—Ç—Ä–æ–∫–∞)
        - description: –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (—Å—Ç—Ä–æ–∫–∞)
        - ready_datetime_str: –Ω–æ–≤–∞—è –¥–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO
        
        –ù–∞—Ö–æ–¥–∏—Ç –∑–∞–∫–∞–∑ –ø–æ –Ω–æ–º–µ—Ä—É –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ –ø–æ–ª—è.
        –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω, –º–µ—Ç–æ–¥ –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É.
        """
        try:
            # –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑ –ø–æ –Ω–æ–º–µ—Ä—É
            # Order.objects.get() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç Order –∏–ª–∏ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ Order.DoesNotExist
            # order_number –ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –∫ int, —Ç–∞–∫ –∫–∞–∫ –≤ –±–∞–∑–µ —ç—Ç–æ —á–∏—Å–ª–æ, –∞ –∏–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ —Å—Ç—Ä–æ–∫–∞
            order = Order.objects.get(order_number=int(order_number))
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –∑–∞–∫–∞–∑–∞
            order.customer_name = customer_name
            order.description = description
            
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã –≤ –æ–±—ä–µ–∫—Ç datetime
            ready_dt_naive = timezone.datetime.fromisoformat(ready_datetime_str)
            if ready_dt_naive.tzinfo is None:
                ready_dt = timezone.make_aware(ready_dt_naive)
            else:
                ready_dt = ready_dt_naive
            
            order.ready_datetime = ready_dt
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            order.save()
            
            # –õ–æ–≥–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
            print(f"‚úèÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω –∑–∞–∫–∞–∑ ‚Ññ{order.order_number}")
            
        except Order.DoesNotExist:
            # –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –º–æ–∂–Ω–æ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ
            print(f"‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∑–∞–∫–∞–∑–∞ ‚Ññ{order_number}")
            pass
        except ValueError:
            # –ï—Å–ª–∏ order_number –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ int
            print(f"‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: {order_number}")
            pass
    
    @database_sync_to_async
    def change_order_status(self, order_number, new_status):
        """
        –ò–∑–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞.
        
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - order_number: –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ —á–∏—Å–ª–æ)
        - new_status: –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å ('accepted', 'in_progress', 'ready', 'completed')
        
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å —è–≤–ª—è–µ—Ç—Å—è –¥–æ–ø—É—Å—Ç–∏–º—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏–∑ STATUS_CHOICES.
        """
        try:
            # –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑ –ø–æ –Ω–æ–º–µ—Ä—É
            order = Order.objects.get(order_number=int(order_number))
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –¥–æ–ø—É—Å—Ç–∏–º
            # –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –∏–∑ STATUS_CHOICES –º–æ–¥–µ–ª–∏ Order
            valid_statuses = [status[0] for status in Order.STATUS_CHOICES]
            
            if new_status in valid_statuses:
                # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –¥–æ–ø—É—Å—Ç–∏–º - –æ–±–Ω–æ–≤–ª—è–µ–º
                old_status = order.status  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                order.status = new_status
                order.save()
                
                # –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
                print(f"üîÑ –ò–∑–º–µ–Ω–µ–Ω —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ ‚Ññ{order.order_number}: {old_status} -> {new_status}")
                
                # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ 'completed' (–≤—ã–¥–∞–Ω), –∑–∞–∫–∞–∑ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º
                if new_status == Order.STATUS_COMPLETED:
                    print(f"‚úÖ –ó–∞–∫–∞–∑ ‚Ññ{order.order_number} –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π")
            else:
                # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º - –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
                print(f"‚ö†Ô∏è –ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è –∑–∞–∫–∞–∑–∞ ‚Ññ{order.order_number}: {new_status}")
                
        except Order.DoesNotExist:
            # –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω
            print(f"‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∑–∞–∫–∞–∑–∞ ‚Ññ{order_number}")
            pass
        except ValueError:
            # –ï—Å–ª–∏ order_number –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ int
            print(f"‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: {order_number}")
            pass
    
    @database_sync_to_async
    def delete_order(self, order_number):
        """
        –£–¥–∞–ª—è–µ—Ç –∑–∞–∫–∞–∑ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
        
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - order_number: –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ —á–∏—Å–ª–æ)
        
        –ù–∞—Ö–æ–¥–∏—Ç –∑–∞–∫–∞–∑ –ø–æ –Ω–æ–º–µ—Ä—É –∏ —É–¥–∞–ª—è–µ—Ç –µ–≥–æ.
        –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω, –º–µ—Ç–æ–¥ –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É.
        """
        try:
            # –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑ –ø–æ –Ω–æ–º–µ—Ä—É
            order = Order.objects.get(order_number=int(order_number))
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
            order_info = f"‚Ññ{order.order_number} ({order.customer_name})"
            
            # –£–¥–∞–ª—è–µ–º –∑–∞–∫–∞–∑ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            order.delete()
            
            # –õ–æ–≥–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
            print(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω –∑–∞–∫–∞–∑ {order_info}")
            
        except Order.DoesNotExist:
            # –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            print(f"‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∑–∞–∫–∞–∑–∞ ‚Ññ{order_number}")
            pass
        except ValueError:
            # –ï—Å–ª–∏ order_number –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ int
            print(f"‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: {order_number}")
            pass
    
    @database_sync_to_async
    def get_orders_by_status(self):
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∑–∞–∫–∞–∑—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–∞–∑–¥–µ–ª—è–µ—Ç –∏—Ö –Ω–∞:
        1. –ê–∫—Ç–∏–≤–Ω—ã–µ (—Å—Ç–∞—Ç—É—Å—ã: accepted, in_progress, ready)
        2. –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ (—Å—Ç–∞—Ç—É—Å: completed)
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –∫–æ—Ä—Ç–µ–∂ –∏–∑ –¥–≤—É—Ö —Å–ø–∏—Å–∫–æ–≤ (active_orders, completed_orders)
        """
        
        # –ü–æ–ª—É—á–∞–µ–º –í–°–ï –∑–∞–∫–∞–∑—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        # Order.objects.all() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç QuerySet - –Ω–∞–±–æ—Ä –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ Order
        all_orders = Order.objects.all()
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        active_orders = []
        completed_orders = []
        
        # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∑–∞–∫–∞–∑–∞–º –∏ —Ä–∞–∑–¥–µ–ª—è–µ–º –∏—Ö –ø–æ —Å—Ç–∞—Ç—É—Å—É
        for order in all_orders:
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç Order –≤ —Å–ª–æ–≤–∞—Ä—å —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ to_dict() –º–æ–¥–µ–ª–∏
            # to_dict() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –ø–æ–ª—è–º–∏ –∑–∞–∫–∞–∑–∞ –≤ —É–¥–æ–±–Ω–æ–º –¥–ª—è JSON —Ñ–æ—Ä–º–∞—Ç–µ
            order_dict = order.to_dict()
            
            # –†–∞–∑–¥–µ–ª—è–µ–º –∑–∞–∫–∞–∑—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É
            if order.status == Order.STATUS_COMPLETED:
                # –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã (—Å—Ç–∞—Ç—É—Å 'completed')
                completed_orders.append(order_dict)
            else:
                # –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã: 'accepted', 'in_progress', 'ready')
                active_orders.append(order_dict)
        
        # –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        print(f"üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: –∞–∫—Ç–∏–≤–Ω—ã—Ö - {len(active_orders)}, –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö - {len(completed_orders)}")
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ—Ä—Ç–µ–∂ —Å –¥–≤—É–º—è —Å–ø–∏—Å–∫–∞–º–∏
        return active_orders, completed_orders